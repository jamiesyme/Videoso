<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Videoso</title>
		<link href="https://unpkg.com/video.js/dist/video-js.css" rel="stylesheet">
	</head>

	<body>
		<h1>Videoso</h1>
		<hr>
		<p>Upload a new video:</p>
		<form id="uploadForm">
			<input id="videoTitleInput" type="text" name="title" placeholder="Title">
			<br>
			<input id="videoFileInput" type="file" accept="video/*" name="videoFile">
			<br>
			<input id="videoSubmit" type="submit" value="Upload">
		</form>
		<hr>
		<ul id="videoList">
		</ul>

		<script src="https://unpkg.com/video.js/dist/video.js"></script>
		<script src="//cdn.dashjs.org/latest/dash.all.debug.js"></script>
		<script src="https://unpkg.com/videojs-contrib-dash/dist/videojs-dash.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script>
		function videoLiFromJson(parentElement, video) {
			var docId = 'v_' + video.videoId;
			$('<h2>')
				.text(video.title)
				.appendTo(parentElement);
			$('<video>')
				.attr('id', docId)
				.attr('width', 480)
				.attr('height', 360)
				.attr('controls', true)
				.addClass('video-js')
				.addClass('vjs-default-skin')
				.addClass('vjs-big-play-centered')
				.appendTo(parentElement);
			var player = videojs(docId);
			player.src({
				src: video.videoMpdUrl,
				type: 'application/dash+xml'
			});
		}

		$('#uploadForm').submit(function(e) {
			e.preventDefault();

			function lockForm() {
				$('#videoSubmit')
					.prop('disabled', true)
					.val('Uploading...');
			}
			function unlockForm() {
				$('#videoSubmit')
					.prop('disabled', false)
					.val('Upload');
			}

			lockForm();
			var formData = new FormData($('#uploadForm')[0]);
			$.ajax({
				url: 'http://dev-videoso:8001/videos',
				type: 'post',
				data: formData,
				processData: false,
				contentType: false,
				success: function(data) {
					$('#uploadForm')[0].reset();
					unlockForm();
					var $li = $('<li>').prependTo('#videoList');
					videoLiFromJson($li, data.video);
				},
				error: function() {
					alert('Upload failed. Please try again later.');
					unlockForm();
				}
			});
		});

		$.getJSON('http://dev-videoso:8001/videos')
			.done(function(data) {
				$.each(data.videos, function(i, video) {
					var $li = $('<li>').appendTo('#videoList');
					videoLiFromJson($li, video);
				});
			})
			.fail(function(jqxhr, textStatus, error) {
				var err = textStatus + ", " + error;
				console.log("Failed to request videos: " + err);
			});
		</script>
	</body>
</html>
