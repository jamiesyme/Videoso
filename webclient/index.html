<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Videoso</title>

		<!-- Video.js CSS -->
		<link href="https://unpkg.com/video.js/dist/video-js.css" rel="stylesheet">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

		<!-- Bootstrap callout CSS -->
		<!-- Find here: https://cpratt.co/twitter-bootstrap-callout-css-styles/ -->
		<style>
		.bs-callout {
			padding: 20px;
			margin: 20px 0;
			border: 1px solid #eee;
			border-left-width: 5px;
			border-radius: 3px;
		}
		.bs-callout h4 {
			margin-top: 0;
			margin-bottom: 5px;
		}
		.bs-callout-warning {
			border-left-color: #f0ad4e;
		}
		.bs-callout-warning h4 {
			color: #f0ad4e;
		}
		</style>

		<!-- Videoso CSS -->
		<style>
		h1 {
			margin-bottom: 20px;
		}
		#pageTitle {
			height: 120px;
			line-height: 120px;
			background-color: #1C4666;
			color: white;
			font-size: 42px;
			text-align: center;
		}
		section {
			margin-bottom: 20px;
		}
		ul#videoList {
			margin-top: -10px;
		}
		#videoList li {
			margin-top: 20px;
		}
		@media only screen and (max-width : 767px) {
			#videoList li {
				margin-bottom: 40px;
			}
		}
		#videoList li h2 {
			font-size: 20px;
			margin-top: 10px;
			margin-bottom: 20px;
		}
		</style>
	</head>

	<body>
		<div id="pageTitle">Videoso</div>
		<div class="container">
			<div class="row">
				<section class="col-sm-6">
					<h1>Introduction</h1>
					<p>This is a (very) early prototype of Videoso, a video streaming platform.</p>
					<p>When a new video is uploaded, it will be processed using the following steps:</p>
					<ol>
						<li>Transcode the video into various resolutions (320p, <s>480p</s>, <s>720p</s>, and <s>1080p</s>) and bitrates using FFmpeg.</li>
						<li>Generate the MPEG-DASH files required for video streaming using the transcoded video files and MP4Box.</li>
						<li>Upload the MPEG-DASH files to Amazon S3, and save the video information to Postgres.</li>
					</ol>
					<p>For more details, check out the <a href="https://github.com/jamiesyme/videoso">repo on Github</a>.</p>
					<p>This website is still in it's infancy. In the near future I'm going to be working on:</p>
					<ul>
						<li>users;</li>
						<li>video search;</li>
						<li>tag-based subscriptions;</li>
						<li>and improved video processing performance (processing one video on multiple servers simultaneously would be interesting...)</li>
					</ul>
				</section>
				<section class="col-sm-6">
					<h1>Upload</h1>
					<div class="bs-callout bs-callout-warning">
						<h4>Videos are public</h4>
						Any video uploaded will be hosted publicly on this website for anyone to see, and it can only be removed by an administrator. Do not upload anything that you wouldn't want the internet to see.
					</div>
					<div class="bs-callout bs-callout-warning">
						<h4>Videos may be deleted</h4>
						This website is still an early prototype, and as such, is not stable. Don't be surprised if the video you uploaded last week suddenly disappears.
					</div>
					<form id="uploadForm" class="form-horizontal">
						<div class="form-group ">
							<label for="videoTitleInput" class="col-sm-2 control-label">Title</label>
							<div class="col-sm-10">
								<input type="text" maxlength="100" required name="title" id="videoTitleInput" class="form-control" placeholder="Title">
								<p class="help-block">Max 100 characters.</p>
							</div>
						</div>
						<div class="form-group">
							<label for="videoFileInput" class="col-sm-2 control-label">File</label>
							<div class="col-sm-10">
								<input type="file" accept="video/*" required name="videoFile" id="videoFileInput">
								<p class="help-block">Max 100 MB. Supported formats: mp4.</p>
							</div>
						</div>
						<div class="form-group">
							<div class="col-sm-offset-2 col-sm-10">
								<input type="submit" id="videoSubmit" class="btn btn-primary" value="Upload">
							</div>
						</div>
					</form>
				</section>
			</div>
		</div>
		<section class="container">
			<h1>Videos</h1>
			<ul id="videoList" class="row list-unstyled"></ul>
		</section>

		<!-- Video.js JS -->
		<script src="https://unpkg.com/video.js/dist/video.js"></script>
		<script src="//cdn.dashjs.org/latest/dash.all.debug.js"></script>
		<script src="https://unpkg.com/videojs-contrib-dash/dist/videojs-dash.js"></script>

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

		<!-- Bootstrap JS -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

		<!-- Videoso JS -->
		<script>
		function prependVideoToList(video) {
			var $li = $('<li>')
				.addClass('col-sm-6')
				.prependTo('#videoList');
			$('#videoList > div.clearfix').remove();
			$('#videoList li:nth-child(2n)').after(
				$('<div>')
					.addClass('clearfix')
					.addClass('hidden-xs')
			);
			var docId = 'v_' + video.videoId;
			$('<video>')
				.attr('id', docId)
				.attr('controls', true)
				.attr('data-setup', '{"fluid": true}')
				.addClass('video-js')
				.addClass('vjs-default-skin')
				.addClass('vjs-big-play-centered')
				.appendTo($li);
			$('<h2>')
				.text(video.title)
				.appendTo($li);
			var player = videojs(docId);
			player.src({
				src: video.videoMpdUrl,
				type: 'application/dash+xml'
			});
		}
		$('#videoFileInput').on('change', function(e) {
			var sizeLimit = 100 * Math.pow(2, 20);
			var files = e.currentTarget.files;
			if (files.length > 0 && files[0].size > sizeLimit) {
				alert('Video file is too large (> 100 MB).');
				$(e.currentTarget).val('');
			}
		});
		$('#uploadForm').submit(function(e) {
			e.preventDefault();

			function lockForm() {
				$('#videoSubmit')
					.prop('disabled', true)
					.val('Uploading...');
			}
			function unlockForm() {
				$('#videoSubmit')
					.prop('disabled', false)
					.val('Upload');
			}

			lockForm();
			var formData = new FormData($('#uploadForm')[0]);
			$.ajax({
				url: 'http://dev-videoso:8001/videos',
				type: 'post',
				data: formData,
				processData: false,
				contentType: false,
				success: function(data) {
					$('#uploadForm')[0].reset();
					unlockForm();
					prependVideoToList(data.video);
				},
				error: function() {
					alert('Upload failed. Please try again later.');
					unlockForm();
				}
			});
		});
		$.getJSON('http://dev-videoso:8001/videos')
			.done(function(data) {
				data.videos.reverse();
				data.videos.forEach(prependVideoToList);
			})
			.fail(function(jqxhr, textStatus, error) {
				var err = textStatus + ", " + error;
				console.log("Failed to request videos: " + err);
			});
		</script>
	</body>
</html>
